<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é»˜å¥‘å¤§è€ƒé©— | Stella & å‡±æ™¨</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Config & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        morandi: {
                            bg: '#F2F0EB',       /* ç‡•éº¥ç° */
                            card: '#FFFFFF',
                            dark: '#5F6C6C',     /* éµç°ç¶  */
                            main: '#8F9E99',     /* é¼ å°¾è‰ */
                            accent: '#D4C4B7',   /* å¥¶èŒ¶è‰² */
                            text: '#434343',     /* ç‚­ç° */
                            sub: '#949494',      /* éŠ€ç° */
                            error: '#C68E8E'     /* ä¹¾ç‡¥ç«ç‘°ç´… */
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                        serif: ['Noto Serif TC', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #F2F0EB; 
            -webkit-tap-highlight-color: transparent;
        }
        .slide-up { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .spin { animation: spin 1s linear infinite; }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 10px 40px rgba(95, 108, 108, 0.08);
        }

        .btn-touch { transition: all 0.2s; }
        .btn-touch:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --------------------------------------------------
        // æ ¸å¿ƒé‚è¼¯ï¼šChat Parser & Generator
        // --------------------------------------------------
        
        const KEYWORDS = {
            items: ['é‘°åŒ™', 'éŒ¢åŒ…', 'æ‰‹æ©Ÿ', 'å°ç« ', 'å­˜æ‘º', 'é›¨å‚˜', 'ä¾¿ç•¶', 'å¤–å¥—', 'çœ¼é¡', 'åƒåœ¾', 'å®‰å…¨å¸½', 'æ‚ éŠå¡'],
            food: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'éº¥ç•¶å‹', 'è‚¯å¾·åŸº', 'ç«é‹', 'ç‡’è‚‰', 'æ‹‰éºµ', 'å¥¶èŒ¶', 'å’–å•¡', 'é»‘ç³–ç³•', 'åå¸', 'è›‹é¤…', 'é›æ’', 'æ»·è‚‰é£¯'],
            actions: ['ä¸Šç­', 'ä¸‹ç­', 'åŠ ç­', 'ç¡è¦º', 'è³´åºŠ', 'æ´—æ¾¡', 'ç”Ÿæ°£', 'å¤§å“­', 'é–‹å¿ƒ', 'ç„¦æ…®', 'å¤§ç¬‘', 'é¢è©¦'],
            locations: ['å…¬å¸', 'å®¶è£¡', 'æ·é‹', 'æ¾³æ´²', 'æ—¥æœ¬', 'å°éŠ€', 'è¨ºæ‰€', 'æ˜¥ç±³', 'è¬å®¶é¦™', 'èŒ¶è‘‰è¡Œ', 'ç‰™é†«'],
            people: ['ç¶“ç†', 'è€é—†', 'åŒäº‹', 'å®¢æˆ¶', 'é˜¿åŒ—', 'é˜¿å§¨', 'è€å…¬', 'è€å©†']
        };

        class ChatParser {
            constructor() {
                this.messages = [];
            }

            parse(text) {
                const lines = text.split('\n');
                this.messages = [];
                let currentDate = '';

                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;

                    if (line.match(/^\d{4}\/\d{1,2}\/\d{1,2}/) || line.match(/^[A-Za-z]{3}, \d{2}\/\d{2}\/\d{4}/)) {
                        currentDate = line;
                        return;
                    }

                    const parts = line.split('\t');
                    if (parts.length >= 3) {
                        const time = parts[0].trim();
                        const rawName = parts[1].trim();
                        const content = parts.slice(2).join(' ').trim();

                        let speaker = null;
                        if (rawName.includes('Stella')) {
                            speaker = 'Stella';
                        } else if (rawName.includes('å‡±æ™¨')) {
                            speaker = 'å‡±æ™¨';
                        }

                        if (speaker && content) {
                            this.messages.push({
                                date: currentDate,
                                time,
                                speaker,
                                content,
                                length: content.length,
                                isSticker: content.includes('[è²¼åœ–]') || content === 'è²¼åœ–',
                                isImage: content.includes('[ç…§ç‰‡]') || content === 'ç…§ç‰‡'
                            });
                        }
                    }
                });
                return this.messages;
            }

            generateQuestions() {
                if (this.messages.length === 0) return [];
                const questions = [];
                let qId = 1;

                const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);

                // 1. èªéŒ„é¡Œ
                const validQuotes = this.messages.filter(m => 
                    m.length >= 4 && m.length < 35 && !m.isSticker && !m.isImage && !m.content.includes('http')
                );
                
                shuffle(validQuotes).slice(0, 60).forEach(msg => {
                    questions.push({
                        id: qId++,
                        type: 'quote',
                        text: `è«‹å•æ˜¯èª°èªªäº†é€™å¥è©±ï¼šã€Œ${msg.content}ã€ï¼Ÿ`,
                        options: ['Stella', 'å‡±æ™¨', 'å…©äººéƒ½èªªé', 'é€™å¥è©±æ˜¯è½‰å‚³çš„'],
                        answer: msg.speaker
                    });
                });

                // 2. å¡«ç©ºé¡Œ
                const keywordTypes = ['items', 'food', 'locations', 'actions'];
                keywordTypes.forEach(kType => {
                    const words = KEYWORDS[kType];
                    const candidates = this.messages.filter(m => words.some(w => m.content.includes(w)));
                    
                    shuffle(candidates).slice(0, 40).forEach(msg => {
                        const targetWord = words.find(w => msg.content.includes(w));
                        if (!targetWord || msg.length < 5) return;

                        const maskedContent = msg.content.replace(targetWord, 'ï¼¿ï¼¿');
                        const distractors = shuffle(words.filter(w => w !== targetWord)).slice(0, 3);
                        while(distractors.length < 3) distractors.push('æ±è¥¿');
                        
                        const options = shuffle([targetWord, ...distractors]);

                        questions.push({
                            id: qId++,
                            type: 'cloze',
                            text: `${msg.speaker} æ›¾èªªï¼šã€Œ${maskedContent}ã€ï¼Ÿ`,
                            options: options,
                            answer: targetWord
                        });
                    });
                });

                // 3. çµ±è¨ˆé¡Œ
                const stickerCounts = { Stella: 0, å‡±æ™¨: 0 };
                this.messages.forEach(m => { if (m.isSticker) stickerCounts[m.speaker]++; });
                questions.push({
                    id: qId++,
                    type: 'stat',
                    text: 'æ ¹æ“šå°è©±ç´€éŒ„ï¼Œèª°å‚³é€ã€Œè²¼åœ–ã€çš„æ¬¡æ•¸æ¯”è¼ƒå¤šï¼Ÿ',
                    options: ['Stella', 'å‡±æ™¨', 'å·®ä¸å¤š', 'å®Œå…¨ä¸å‚³è²¼åœ–'],
                    answer: stickerCounts.Stella > stickerCounts.å‡±æ™¨ ? 'Stella' : 'å‡±æ™¨'
                });

                const nightCounts = { Stella: 0, å‡±æ™¨: 0 };
                this.messages.forEach(m => {
                    const hour = parseInt(m.time.split(':')[0]);
                    if (hour >= 0 && hour < 4) nightCounts[m.speaker]++;
                });
                questions.push({
                    id: qId++,
                    type: 'stat',
                    text: 'èª°æ¯”è¼ƒå¸¸åœ¨åŠå¤œ (00:00-04:00) å‚³è¨Šæ¯ï¼Ÿ',
                    options: ['Stella', 'å‡±æ™¨', 'é »ç‡å·®ä¸å¤š', 'å…©äººéƒ½æ—©ç¡'],
                    answer: nightCounts.Stella > nightCounts.å‡±æ™¨ ? 'Stella' : 'å‡±æ™¨'
                });

                return shuffle(questions);
            }
        }

        // --------------------------------------------------
        // UI Components
        // --------------------------------------------------
        
        function App() {
            const [view, setView] = useState('loading');
            const [errorMessage, setErrorMessage] = useState('');
            const [questions, setQuestions] = useState([]);
            const [currentUser, setCurrentUser] = useState('');
            const [currentQuizSet, setCurrentQuizSet] = useState([]);
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [answers, setAnswers] = useState({});
            const [score, setScore] = useState(0);

            const [history, setHistory] = useState(() => {
                const saved = localStorage.getItem('quiz_history_final');
                return saved ? JSON.parse(saved) : { Stella: [], å‡±æ™¨: [] };
            });

            useEffect(() => {
                localStorage.setItem('quiz_history_final', JSON.stringify(history));
            }, [history]);

            useEffect(() => {
                const initData = async () => {
                    try {
                        const response = await fetch('./line-chat.txt');
                        if (!response.ok) throw new Error("è®€å–ä¸åˆ° line-chat.txtï¼Œè«‹ç¢ºèªæª”æ¡ˆä½ç½®ã€‚");
                        
                        const text = await response.text();
                        const parser = new ChatParser();
                        const parsedMsgs = parser.parse(text);

                        if (parsedMsgs.length < 5) throw new Error("è§£æå‡ºçš„è¨Šæ¯éå°‘ã€‚");

                        const genQuestions = parser.generateQuestions();
                        setQuestions(genQuestions);
                        setTimeout(() => setView('menu'), 800);
                    } catch (err) {
                        setErrorMessage(err.message);
                        setView('error');
                    }
                };
                initData();
            }, []);

            const startQuiz = (user) => {
                setCurrentUser(user);
                const userHistory = history[user] || [];
                let available = questions.filter(q => !userHistory.includes(q.id));
                if (available.length < 20) {
                    setHistory(prev => ({ ...prev, [user]: [] }));
                    available = [...questions];
                }
                const quizSet = available.sort(() => Math.random() - 0.5).slice(0, 20);
                setCurrentQuizSet(quizSet);
                setCurrentQIndex(0);
                setAnswers({});
                setView('quiz');
            };

            const handleAnswer = (option) => {
                const q = currentQuizSet[currentQIndex];
                setAnswers(prev => ({ ...prev, [q.id]: option }));
                setTimeout(() => {
                    if (currentQIndex < 19) setCurrentQIndex(prev => prev + 1);
                    else finishQuiz();
                }, 300);
            };

            const finishQuiz = () => {
                let correctCount = 0;
                const newHistoryIds = [];
                currentQuizSet.forEach(q => {
                    if (answers[q.id] === q.answer) correctCount++;
                    newHistoryIds.push(q.id);
                });
                setScore(Math.round((correctCount / 20) * 100));
                setHistory(prev => ({
                    ...prev,
                    [currentUser]: [...(prev[currentUser] || []), ...newHistoryIds]
                }));
                setView('result');
            };

            if (view === 'loading') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-morandi-bg">
                    <div className="w-10 h-10 border-4 border-morandi-main border-t-transparent rounded-full spin mb-4"></div>
                    <p className="text-morandi-main font-bold tracking-widest animate-pulse">è®€å–å°è©±ç´€éŒ„ä¸­...</p>
                </div>
            );

            if (view === 'error') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-morandi-bg p-8 text-center">
                    <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md">
                        <h2 className="text-xl font-bold text-morandi-error mb-4">è®€å–å¤±æ•—</h2>
                        <p className="text-morandi-text mb-6 text-sm">{errorMessage}</p>
                        <button onClick={() => window.location.reload()} className="px-6 py-2 bg-morandi-main text-white rounded-lg">é‡è©¦</button>
                    </div>
                </div>
            );

            if (view === 'menu') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-morandi-bg">
                    <div className="glass-card w-full max-w-md p-8 rounded-3xl z-10 slide-up text-center">
                        <h1 className="text-3xl font-serif font-bold text-morandi-text mb-2 tracking-wide">é»˜å¥‘å¤§è€ƒé©—</h1>
                        <p className="text-morandi-main text-xs uppercase tracking-[0.2em] mb-8">Stella & å‡±æ™¨ å°ˆå±¬ç‰ˆ</p>
                        <div className="space-y-4">
                            <button onClick={() => startQuiz('Stella')} className="w-full py-5 rounded-xl bg-white border border-morandi-accent text-morandi-text hover:bg-morandi-main hover:text-white transition-all shadow-sm flex items-center justify-center space-x-3 btn-touch">
                                <span className="text-2xl">ğŸ‘©ğŸ»</span>
                                <div className="text-left"><span className="block font-bold text-lg">æˆ‘æ˜¯ Stella</span><span className="text-xs opacity-70">é–‹å§‹æ¸¬é©—</span></div>
                            </button>
                            <button onClick={() => startQuiz('å‡±æ™¨')} className="w-full py-5 rounded-xl bg-white border border-morandi-main text-morandi-text hover:bg-morandi-dark hover:text-white transition-all shadow-sm flex items-center justify-center space-x-3 btn-touch">
                                <span className="text-2xl">ğŸ‘¦ğŸ»</span>
                                <div className="text-left"><span className="block font-bold text-lg">æˆ‘æ˜¯ å‡±æ™¨</span><span className="text-xs opacity-70">é–‹å§‹æ¸¬é©—</span></div>
                            </button>
                        </div>
                    </div>
                </div>
            );

            if (view === 'quiz') {
                const q = currentQuizSet[currentQIndex];
                const progress = ((currentQIndex + 1) / 20) * 100;
                return (
                    <div className="min-h-screen flex flex-col bg-morandi-bg">
                        <div className="h-1.5 w-full bg-gray-200 fixed top-0 z-50">
                            <div className="h-full bg-morandi-main transition-all duration-300" style={{width: `${progress}%`}}></div>
                        </div>
                        <div className="flex-1 flex flex-col max-w-md mx-auto w-full p-6 pt-12">
                            <div className="flex justify-between items-center mb-6">
                                <span className="text-morandi-main font-bold text-lg font-serif">Q{currentQIndex + 1}</span>
                                <span className="px-3 py-1 bg-white rounded-full text-xs text-morandi-sub shadow-sm">{currentUser} çš„æŒ‘æˆ°</span>
                            </div>
                            <div className="bg-white rounded-3xl p-8 shadow-sm mb-6 min-h-[180px] flex items-center justify-center border border-gray-100 slide-up">
                                <h2 className="text-xl font-bold text-morandi-text text-center leading-relaxed">{q.text}</h2>
                            </div>
                            <div className="space-y-3">
                                {q.options.map((opt, idx) => (
                                    <button key={idx} onClick={() => handleAnswer(opt)} className="w-full p-4 rounded-xl text-left transition-all duration-200 border bg-white text-morandi-text border-transparent shadow-sm hover:border-morandi-accent btn-touch">
                                        <span className="font-medium text-base">{opt}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'result') return (
                <div className="min-h-screen bg-morandi-bg p-6 flex flex-col items-center justify-center">
                    <div className="w-full max-w-md slide-up">
                        <div className="bg-white rounded-3xl p-8 shadow-xl text-center mb-6 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-morandi-main to-morandi-accent"></div>
                            <h2 className="text-morandi-sub text-xs uppercase tracking-widest mb-4">Final Score</h2>
                            <div className="text-7xl font-serif font-bold text-morandi-text mb-4">{score}</div>
                            <p className="text-morandi-dark font-medium px-4 mb-6">{score >= 80 ? "è¶…ç´šæœ‰é»˜å¥‘ï¼" : score >= 60 ? "é‚„ä¸éŒ¯å–”ï¼" : "å†åŠ æ²¹ XD"}</p>
                            <div className="text-left bg-gray-50 rounded-xl p-4 max-h-60 overflow-y-auto mb-6 text-sm">
                                <h3 className="font-bold text-morandi-text mb-2">ç­”éŒ¯é¡Œç›®æª¢è¨ï¼š</h3>
                                {currentQuizSet.map((q, idx) => {
                                    const myAns = answers[q.id];
                                    if (myAns === q.answer) return null;
                                    return (
                                        <div key={q.id} className="mb-3 border-b border-gray-200 pb-2 last:border-0">
                                            <p className="text-gray-800 mb-1">{idx+1}. {q.text}</p>
                                            <div className="flex justify-between text-xs"><span className="text-morandi-error">ä½ : {myAns}</span><span className="text-morandi-main font-bold">æ­£è§£: {q.answer}</span></div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => startQuiz(currentUser)} className="flex-1 py-4 bg-morandi-main text-white rounded-xl font-bold shadow-lg">å†ç©ä¸€æ¬¡</button>
                            <button onClick={() => setView('menu')} className="flex-1 py-4 bg-white text-morandi-text border border-gray-200 rounded-xl font-bold">æ›äººæŒ‘æˆ°</button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
