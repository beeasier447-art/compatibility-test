<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>默契大考驗 | Stella & 凱晨</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Config & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        morandi: {
                            bg: '#F2F0EB',       /* 燕麥灰 */
                            card: '#FFFFFF',
                            dark: '#5F6C6C',     /* 鐵灰綠 */
                            main: '#8F9E99',     /* 鼠尾草 */
                            accent: '#D4C4B7',   /* 奶茶色 */
                            text: '#434343',     /* 炭灰 */
                            sub: '#949494',      /* 銀灰 */
                            error: '#C68E8E',    /* 乾燥玫瑰紅 */
                            stella: '#B5C0B3',   /* Stella 專屬綠 */
                            kevin: '#B2BCC2'     /* 凱晨 專屬藍灰 */
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                        serif: ['Noto Serif TC', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #F2F0EB; 
            -webkit-tap-highlight-color: transparent;
        }
        .slide-up { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .spin { animation: spin 1s linear infinite; }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 10px 40px rgba(95, 108, 108, 0.08);
        }

        .btn-touch { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-touch:active { transform: scale(0.95); }
        .btn-touch:hover .avatar-icon { transform: scale(1.1) rotate(5deg); }
        
        .avatar-icon { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --------------------------------------------------
        // 可愛頭像組件 (SVG)
        // --------------------------------------------------
        
        const StellaAvatar = () => (
            <svg viewBox="0 0 100 100" className="w-16 h-16 avatar-icon">
                <circle cx="50" cy="50" r="48" fill="#B5C0B3" />
                <path d="M50 25c-15 0-22 10-22 20 0 15 10 25 22 25s22-10 22-25c0-10-7-20-22-20z" fill="#FFF" opacity="0.9" />
                <circle cx="40" cy="45" r="3" fill="#5F6C6C" />
                <circle cx="60" cy="45" r="3" fill="#5F6C6C" />
                <path d="M45 55c2 2 8 2 10 0" stroke="#5F6C6C" strokeWidth="2" fill="none" strokeLinecap="round" />
                <path d="M28 45c-5-5-2-15 2-18 8-5 25-5 35 2 5 4 8 15 5 20" fill="none" stroke="#FFF" strokeWidth="3" strokeLinecap="round" />
                <circle cx="35" cy="50" r="4" fill="#E8B7B7" opacity="0.4" />
                <circle cx="65" cy="50" r="4" fill="#E8B7B7" opacity="0.4" />
            </svg>
        );

        const KevinAvatar = () => (
            <svg viewBox="0 0 100 100" className="w-16 h-16 avatar-icon">
                <circle cx="50" cy="50" r="48" fill="#B2BCC2" />
                <path d="M50 28c-12 0-20 8-20 18 0 12 8 22 20 22s20-10 20-22c0-10-8-18-20-18z" fill="#FFF" opacity="0.9" />
                <rect x="35" y="42" width="10" height="10" rx="2" fill="none" stroke="#5F6C6C" strokeWidth="1.5" />
                <rect x="55" y="42" width="10" height="10" rx="2" fill="none" stroke="#5F6C6C" strokeWidth="1.5" />
                <path d="M45 47h10" stroke="#5F6C6C" strokeWidth="1.5" />
                <path d="M47 58h6" stroke="#5F6C6C" strokeWidth="2" strokeLinecap="round" />
                <path d="M30 40c0-10 10-15 20-15s20 5 20 15" fill="none" stroke="#FFF" strokeWidth="4" strokeLinecap="round" />
            </svg>
        );

        // --------------------------------------------------
        // 核心邏輯：Chat Parser & Generator
        // --------------------------------------------------
        
        const KEYWORDS = {
            items: ['鑰匙', '錢包', '手機', '印章', '存摺', '雨傘', '便當', '外套', '眼鏡', '垃圾', '安全帽', '悠遊卡'],
            food: ['早餐', '午餐', '晚餐', '麥當勞', '肯德基', '火鍋', '燒肉', '拉麵', '奶茶', '咖啡', '黑糖糕', '吐司', '蛋餅', '雞排', '滷肉飯'],
            actions: ['上班', '下班', '加班', '睡覺', '賴床', '洗澡', '生氣', '大哭', '開心', '焦慮', '大笑', '面試'],
            locations: ['公司', '家裡', '捷運', '澳洲', '日本', '台銀', '診所', '春米', '萬家香', '茶葉行', '牙醫'],
            people: ['經理', '老闆', '同事', '客戶', '阿北', '阿姨', '老公', '老婆']
        };

        class ChatParser {
            constructor() {
                this.messages = [];
            }

            parse(text) {
                const lines = text.split('\n');
                this.messages = [];
                let currentDate = '';

                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;

                    if (line.match(/^\d{4}\/\d{1,2}\/\d{1,2}/) || line.match(/^[A-Za-z]{3}, \d{2}\/\d{2}\/\d{4}/)) {
                        currentDate = line;
                        return;
                    }

                    const parts = line.split('\t');
                    if (parts.length >= 3) {
                        const time = parts[0].trim();
                        const rawName = parts[1].trim();
                        const content = parts.slice(2).join(' ').trim();

                        let speaker = null;
                        if (rawName.includes('Stella')) {
                            speaker = 'Stella';
                        } else if (rawName.includes('凱晨')) {
                            speaker = '凱晨';
                        }

                        if (speaker && content) {
                            this.messages.push({
                                date: currentDate,
                                time,
                                speaker,
                                content,
                                length: content.length,
                                isSticker: content.includes('[貼圖]') || content === '貼圖',
                                isImage: content.includes('[照片]') || content === '照片'
                            });
                        }
                    }
                });
                return this.messages;
            }

            generateQuestions() {
                if (this.messages.length === 0) return [];
                const questions = [];
                let qId = 1;

                const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);

                const validQuotes = this.messages.filter(m => 
                    m.length >= 4 && m.length < 35 && !m.isSticker && !m.isImage && !m.content.includes('http')
                );
                
                shuffle(validQuotes).slice(0, 60).forEach(msg => {
                    questions.push({
                        id: qId++,
                        type: 'quote',
                        text: `請問是誰說了這句話：「${msg.content}」？`,
                        options: ['Stella', '凱晨', '兩人都說過', '這句話是轉傳的'],
                        answer: msg.speaker
                    });
                });

                const keywordTypes = ['items', 'food', 'locations', 'actions'];
                keywordTypes.forEach(kType => {
                    const words = KEYWORDS[kType];
                    const candidates = this.messages.filter(m => words.some(w => m.content.includes(w)));
                    
                    shuffle(candidates).slice(0, 40).forEach(msg => {
                        const targetWord = words.find(w => msg.content.includes(w));
                        if (!targetWord || msg.length < 5) return;

                        const maskedContent = msg.content.replace(targetWord, '＿＿');
                        const distractors = shuffle(words.filter(w => w !== targetWord)).slice(0, 3);
                        while(distractors.length < 3) distractors.push('東西');
                        
                        const options = shuffle([targetWord, ...distractors]);

                        questions.push({
                            id: qId++,
                            type: 'cloze',
                            text: `${msg.speaker} 曾說：「${maskedContent}」？`,
                            options: options,
                            answer: targetWord
                        });
                    });
                });

                const stickerCounts = { Stella: 0, 凱晨: 0 };
                this.messages.forEach(m => { if (m.isSticker) stickerCounts[m.speaker]++; });
                questions.push({
                    id: qId++,
                    type: 'stat',
                    text: '根據對話紀錄，誰傳送「貼圖」的次數比較多？',
                    options: ['Stella', '凱晨', '差不多', '完全不傳貼圖'],
                    answer: stickerCounts.Stella > stickerCounts.凱晨 ? 'Stella' : '凱晨'
                });

                const nightCounts = { Stella: 0, 凱晨: 0 };
                this.messages.forEach(m => {
                    const hour = parseInt(m.time.split(':')[0]);
                    if (hour >= 0 && hour < 4) nightCounts[m.speaker]++;
                });
                questions.push({
                    id: qId++,
                    type: 'stat',
                    text: '誰比較常在半夜 (00:00-04:00) 傳訊息？',
                    options: ['Stella', '凱晨', '頻率差不多', '兩人都早睡'],
                    answer: nightCounts.Stella > nightCounts.凱晨 ? 'Stella' : '凱晨'
                });

                return shuffle(questions);
            }
        }

        // --------------------------------------------------
        // UI Components
        // --------------------------------------------------
        
        function App() {
            const [view, setView] = useState('loading');
            const [errorMessage, setErrorMessage] = useState('');
            const [questions, setQuestions] = useState([]);
            const [currentUser, setCurrentUser] = useState('');
            const [currentQuizSet, setCurrentQuizSet] = useState([]);
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [answers, setAnswers] = useState({});
            const [score, setScore] = useState(0);

            const [history, setHistory] = useState(() => {
                const saved = localStorage.getItem('quiz_history_final_v2');
                return saved ? JSON.parse(saved) : { Stella: [], 凱晨: [] };
            });

            useEffect(() => {
                localStorage.setItem('quiz_history_final_v2', JSON.stringify(history));
            }, [history]);

            useEffect(() => {
                const initData = async () => {
                    try {
                        const response = await fetch('./line-chat.txt');
                        if (!response.ok) throw new Error("讀取不到 line-chat.txt，請確認檔案位置。");
                        
                        const text = await response.text();
                        const parser = new ChatParser();
                        const parsedMsgs = parser.parse(text);

                        if (parsedMsgs.length < 5) throw new Error("解析出的訊息過少。");

                        const genQuestions = parser.generateQuestions();
                        setQuestions(genQuestions);
                        setTimeout(() => setView('menu'), 800);
                    } catch (err) {
                        setErrorMessage(err.message);
                        setView('error');
                    }
                };
                initData();
            }, []);

            const startQuiz = (user) => {
                setCurrentUser(user);
                const userHistory = history[user] || [];
                let available = questions.filter(q => !userHistory.includes(q.id));
                if (available.length < 20) {
                    setHistory(prev => ({ ...prev, [user]: [] }));
                    available = [...questions];
                }
                const quizSet = available.sort(() => Math.random() - 0.5).slice(0, 20);
                setCurrentQuizSet(quizSet);
                setCurrentQIndex(0);
                setAnswers({});
                setView('quiz');
            };

            const handleAnswer = (option) => {
                const q = currentQuizSet[currentQIndex];
                setAnswers(prev => ({ ...prev, [q.id]: option }));
                setTimeout(() => {
                    if (currentQIndex < 19) setCurrentQIndex(prev => prev + 1);
                    else finishQuiz();
                }, 300);
            };

            const finishQuiz = () => {
                let correctCount = 0;
                const newHistoryIds = [];
                currentQuizSet.forEach(q => {
                    if (answers[q.id] === q.answer) correctCount++;
                    newHistoryIds.push(q.id);
                });
                setScore(Math.round((correctCount / 20) * 100));
                setHistory(prev => ({
                    ...prev,
                    [currentUser]: [...(prev[currentUser] || []), ...newHistoryIds]
                }));
                setView('result');
            };

            if (view === 'loading') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-morandi-bg">
                    <div className="w-10 h-10 border-4 border-morandi-main border-t-transparent rounded-full spin mb-4"></div>
                    <p className="text-morandi-main font-bold tracking-widest animate-pulse">讀取對話紀錄中...</p>
                </div>
            );

            if (view === 'error') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-morandi-bg p-8 text-center">
                    <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md">
                        <h2 className="text-xl font-bold text-morandi-error mb-4">讀取失敗</h2>
                        <p className="text-morandi-text mb-6 text-sm">{errorMessage}</p>
                        <button onClick={() => window.location.reload()} className="px-6 py-2 bg-morandi-main text-white rounded-lg">重試</button>
                    </div>
                </div>
            );

            if (view === 'menu') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-morandi-bg">
                    <div className="glass-card w-full max-w-md p-8 rounded-3xl z-10 slide-up text-center">
                        <h1 className="text-3xl font-serif font-bold text-morandi-text mb-2 tracking-wide">默契大考驗</h1>
                        <p className="text-morandi-main text-xs uppercase tracking-[0.2em] mb-10">Stella & 凱晨 專屬版</p>
                        
                        <div className="space-y-6">
                            <button 
                                onClick={() => startQuiz('Stella')} 
                                className="w-full p-4 rounded-2xl bg-white border border-morandi-accent hover:border-morandi-stella hover:bg-morandi-stella/5 transition-all shadow-sm flex items-center space-x-6 btn-touch group"
                            >
                                <div className="flex-shrink-0">
                                    <StellaAvatar />
                                </div>
                                <div className="text-left">
                                    <span className="block font-bold text-xl text-morandi-text group-hover:text-morandi-dark">我是 Stella</span>
                                    <span className="text-xs text-morandi-sub">點擊開始挑戰</span>
                                </div>
                            </button>

                            <button 
                                onClick={() => startQuiz('凱晨')} 
                                className="w-full p-4 rounded-2xl bg-white border border-morandi-main hover:border-morandi-kevin hover:bg-morandi-kevin/5 transition-all shadow-sm flex items-center space-x-6 btn-touch group"
                            >
                                <div className="flex-shrink-0">
                                    <KevinAvatar />
                                </div>
                                <div className="text-left">
                                    <span className="block font-bold text-xl text-morandi-text group-hover:text-morandi-dark">我是 凱晨</span>
                                    <span className="text-xs text-morandi-sub">點擊開始挑戰</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            );

            if (view === 'quiz') {
                const q = currentQuizSet[currentQIndex];
                const progress = ((currentQIndex + 1) / 20) * 100;
                return (
                    <div className="min-h-screen flex flex-col bg-morandi-bg">
                        <div className="h-1.5 w-full bg-gray-200 fixed top-0 z-50">
                            <div className="h-full bg-morandi-main transition-all duration-300" style={{width: `${progress}%`}}></div>
                        </div>
                        <div className="flex-1 flex flex-col max-w-md mx-auto w-full p-6 pt-12">
                            <div className="flex justify-between items-center mb-6">
                                <span className="text-morandi-main font-bold text-lg font-serif">Q{currentQIndex + 1}</span>
                                <span className="px-3 py-1 bg-white rounded-full text-xs text-morandi-sub shadow-sm">{currentUser} 的挑戰</span>
                            </div>
                            <div className="bg-white rounded-3xl p-8 shadow-sm mb-6 min-h-[180px] flex items-center justify-center border border-gray-100 slide-up">
                                <h2 className="text-xl font-bold text-morandi-text text-center leading-relaxed">{q.text}</h2>
                            </div>
                            <div className="space-y-3">
                                {q.options.map((opt, idx) => (
                                    <button key={idx} onClick={() => handleAnswer(opt)} className="w-full p-4 rounded-xl text-left transition-all duration-200 border bg-white text-morandi-text border-transparent shadow-sm hover:border-morandi-accent btn-touch">
                                        <span className="font-medium text-base">{opt}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'result') return (
                <div className="min-h-screen bg-morandi-bg p-6 flex flex-col items-center justify-center">
                    <div className="w-full max-w-md slide-up">
                        <div className="bg-white rounded-3xl p-8 shadow-xl text-center mb-6 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-morandi-main to-morandi-accent"></div>
                            <h2 className="text-morandi-sub text-xs uppercase tracking-widest mb-4">Final Score</h2>
                            <div className="text-7xl font-serif font-bold text-morandi-text mb-4">{score}</div>
                            <p className="text-morandi-dark font-medium px-4 mb-6">{score >= 80 ? "超級有默契！" : score >= 60 ? "還不錯喔！" : "再加油 XD"}</p>
                            <div className="text-left bg-gray-50 rounded-xl p-4 max-h-60 overflow-y-auto mb-6 text-sm">
                                <h3 className="font-bold text-morandi-text mb-2">答錯題目檢討：</h3>
                                {currentQuizSet.map((q, idx) => {
                                    const myAns = answers[q.id];
                                    if (myAns === q.answer) return null;
                                    return (
                                        <div key={q.id} className="mb-3 border-b border-gray-200 pb-2 last:border-0">
                                            <p className="text-gray-800 mb-1">{idx+1}. {q.text}</p>
                                            <div className="flex justify-between text-xs"><span className="text-morandi-error">你: {myAns}</span><span className="text-morandi-main font-bold">正解: {q.answer}</span></div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => startQuiz(currentUser)} className="flex-1 py-4 bg-morandi-main text-white rounded-xl font-bold shadow-lg">再玩一次</button>
                            <button onClick={() => setView('menu')} className="flex-1 py-4 bg-white text-morandi-text border border-gray-200 rounded-xl font-bold">換人挑戰</button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
